<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant Form</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6c757d;
            --success-color: #4caf50;
            --background-color: #f9fbfd;
            --card-bg: #ffffff;
            --text-color: #333333;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #2c3e50);
            color: white;
            width: 100%;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-weight: 300;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            padding: 0 20px;
            margin-bottom: 40px;
        }
        
        .flex-container {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 40px;
            transition: var(--transition);
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--secondary-color);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            font-size: 16px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            background-color: #f8fafc;
            transition: var(--transition);
            color: var(--text-color);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.15);
        }
        
        .form-control[readonly] {
            background-color: #f5f7fa;
            border: 1px solid #e1e5eb;
            cursor: not-allowed;
        }
        
        .btn {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            transition: var(--transition);
            text-align: center;
            margin-right: 10px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5a84;
            box-shadow: 0 5px 15px rgba(74, 111, 165, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-icon {
            margin-right: 10px;
        }
        
        #submitButton {
            display: none;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .response-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .response-content {
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            white-space: pre-wrap;
            font-size: 16px;
            height: 350px;
            overflow-y: auto;
        }
        
        .form-status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e8f5e9;
            color: var(--success-color);
            display: none;
        }
        
        .completed {
            display: block;
        }
        
        footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            font-size: 14px;
            color: var(--secondary-color);
            width: 100%;
        }
        
        .card-title {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        @media (max-width: 992px) {
            .flex-container {
                flex-direction: column;
            }
            
            .card {
                width: 100%;
            }
            
            .response-content {
                height: 250px;
            }
        }
        
        @media (max-width: 768px) {
            .card {
                padding: 25px;
            }
            
            .container {
                width: 100%;
                padding: 0 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Voice Assistant Form</h1>
        <p>Complete your information using our advanced voice recognition system</p>
    </div>
    
    <div class="container">
        <div class="flex-container">
            <div class="card">
                <h2 class="card-title">Your Information</h2>
                <form id="myForm">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" class="form-control" id="name" placeholder="Your name" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" class="form-control" id="email" placeholder="Your email" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" placeholder="Your phone number" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">City</label>
                        <input type="text" class="form-control" id="address" placeholder="Your city" readonly>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" id="startButton" class="btn btn-primary">
                            <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                            Start Voice Assistant
                        </button>
                        
                        <button type="button" id="submitButton" class="btn btn-success">
                            <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Submit Form
                        </button>
                    </div>
                    
                    <div id="formStatus" class="form-status">
                        Form submitted successfully. Thank you!
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div class="response-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Assistant Response
                </div>
                <div id="responseArea" class="response-content"></div>
            </div>
        </div>
    </div>
    
    <!-- <footer>
        <p>Â© 2025 Voice Assistant Premium Form | Powered by AWS Lex and Polly</p>
    </footer> -->
    <script>
        const API_ENDPOINT = 'https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com';
        let isListening = false;
        let recognition;
        let sessionId = 'session-' + Date.now();
        let formCompleted = false;
        let speechBuffer = '';
        let debounceTimeout;
        let confirmationState = 'none'; // 'none', 'awaitingEmailConfirmation', 'waitingForNewEmail'
        let lastProcessedEmail = ''; // Track the last processed email
        let confirmedEmail = ''; // Track the final confirmed email
        let isProcessing = false; // Flag to prevent duplicate processing
    
        document.getElementById('startButton').addEventListener('click', toggleVoiceAssistant);
        document.getElementById('submitButton').addEventListener('click', submitForm);
    
        function checkFormCompletion() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            
            if (name && email && phone && address) {
                document.getElementById('submitButton').style.display = 'inline-flex';
                formCompleted = true;
            }
        }
    
        function submitForm() {
            document.getElementById('formStatus').classList.add('completed');
            document.getElementById('submitButton').disabled = true;
            
            console.log("Form submitted with the following data:");
            console.log({
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            });
            
            updateResponseArea("Form has been submitted successfully. Thank you!");
            
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => input.style.backgroundColor = '#f0f2f5');
        }
    
        async function toggleVoiceAssistant() {
            if (isListening) stopListening();
            else await startListening();
        }
    
        async function startListening() {
            isListening = true;
            const startButton = document.getElementById('startButton');
            startButton.innerHTML = `
                <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
                Stop Voice Assistant
            `;
            startButton.classList.add('listening');
            
            await sendToLex("Hello");
            
            try {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = async function(event) {
                    if (isProcessing) return;
                    isProcessing = true;
                    
                    const last = event.results.length - 1;
                    const text = event.results[last][0].transcript;
                    speechBuffer = text;
                    console.log("Raw speech input:", speechBuffer);
                    console.log("Current confirmation state:", confirmationState);
                    
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(async () => {
                        try {
                            const userResponse = speechBuffer.trim();
                            console.log("Processing input:", userResponse);
    
                            if (confirmationState === 'awaitingEmailConfirmation') {
                                await handleEmailConfirmation(userResponse);
                            } else if (confirmationState === 'waitingForNewEmail') {
                                await processEmailInput(userResponse);
                            } else {
                                await sendToLex(speechBuffer);
                            }
                        } catch (error) {
                            console.error("Error processing speech:", error);
                        } finally {
                            speechBuffer = '';
                            isProcessing = false;
                        }
                    }, 1000);
                };
                
                recognition.onend = function() {
                    if (isListening) recognition.start();
                };
                
                recognition.onerror = function(event) {
                    console.error("Speech recognition error:", event.error);
                    isProcessing = false;
                    if (isListening) setTimeout(() => isListening && recognition.start(), 1000);
                };
                
                recognition.start();
            } catch (error) {
                console.error("Error starting speech recognition:", error);
                updateResponseArea("Could not start speech recognition. Please check your browser permissions.");
                isProcessing = false;
            }
        }
    
        async function handleEmailConfirmation(userResponse) {
            const lowerResponse = userResponse.toLowerCase();
            console.log("User confirmed with:", lowerResponse);
            
            if (lowerResponse.includes('yes')) {
                console.log("Confirming email:", lastProcessedEmail);
                confirmedEmail = lastProcessedEmail;
                confirmationState = 'none';
                document.getElementById('email').value = confirmedEmail; // Explicitly update the form field
                console.log("Email field updated to:", confirmedEmail);
                updateResponseArea("Email confirmed. Continuing with the form.");
                await speak("Email confirmed. Continuing with the form.");
                await sendToLex("Continue with form");
            } else if (lowerResponse.includes('no')) {
                confirmationState = 'waitingForNewEmail';
                lastProcessedEmail = '';
                confirmedEmail = '';
                document.getElementById('email').value = '';
                updateResponseArea("Please say your email again.");
                await speak("Please say your email again.");
            } else {
                updateResponseArea("Please say 'yes' or 'no' to confirm your email.");
                await speak("Please say 'yes' or 'no' to confirm your email.");
            }
        }
    
        async function processEmailInput(input) {
            console.log("Processing email input:", input);
            
            let normalizedInput = input.toLowerCase()
                .replace(/\s+at\s+/g, '@')
                .replace(/\s+dot\s+/g, '.')
                .replace(/\s+/g, '');
            
            console.log("Normalized input:", normalizedInput);
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(normalizedInput)) {
                lastProcessedEmail = normalizedInput;
                document.getElementById('email').value = normalizedInput;
                confirmationState = 'awaitingEmailConfirmation';
                updateResponseArea(`I heard your email as: ${normalizedInput}. Is that correct? Say 'yes' or 'no'.`);
                await speak(`I heard your email as: ${normalizedInput}. Is that correct? Say 'yes' or 'no'.`);
            } else {
                const emailPattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/;
                const match = input.match(emailPattern);
                if (match) {
                    const email = match[0];
                    console.log("Extracted email as fallback:", email);
                    lastProcessedEmail = email;
                    document.getElementById('email').value = email;
                    confirmationState = 'awaitingEmailConfirmation';
                    updateResponseArea(`I heard your email as: ${email}. Is that correct? Say 'yes' or 'no'.`);
                    await speak(`I heard your email as: ${email}. Is that correct? Say 'yes' or 'no'.`);
                } else {
                    updateResponseArea("I couldn't recognize that as an email address. Please say your email again, or try spelling it out.");
                    await speak("I couldn't recognize that as an email address. Please say your email again, or try spelling it out.");
                }
            }
        }
    
        function stopListening() {
            isListening = false;
            const startButton = document.getElementById('startButton');
            startButton.innerHTML = `
                <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                Start Voice Assistant
            `;
            startButton.classList.remove('listening');
            if (recognition) recognition.stop();
            clearTimeout(debounceTimeout);
        }
    
        async function sendToLex(text) {
            if (!text || text.trim().length === 0) {
                console.log("Empty input, not sending to Lex");
                return;
            }
    
            try {
                console.log("Sending to Lex:", text);
                const response = await fetch(`${API_ENDPOINT}/lex`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputText: text, sessionId: sessionId })
                });
    
                console.log("Response status:", response.status);
                const responseText = await response.text();
                console.log("Raw Lex response:", responseText);
    
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}, body: ${responseText}`);
    
                const data = JSON.parse(responseText);
                await handleLexResponse(data);
            } catch (error) {
                console.error("Error sending to Lex:", error);
                updateResponseArea("Error: " + error.message);
            }
        }
    
        async function handleLexResponse(lexResponse) {
            console.log("Parsed Lex response:", JSON.stringify(lexResponse, null, 2));
            
            // Skip email processing if we already have a confirmed email
            if (confirmedEmail && lexResponse.sessionState?.intent?.slots?.email?.value?.interpretedValue) {
                console.log("Email already confirmed as:", confirmedEmail, "Skipping Lex email slot reprocessing.");
                lexResponse.sessionState.intent.slots.email = null; // Prevent Lex from overriding
            }
    
            if (lexResponse.sessionState?.intent?.slots) {
                const slots = lexResponse.sessionState.intent.slots;
                for (const [key, value] of Object.entries(slots)) {
                    if (value?.value?.interpretedValue) {
                        const interpretedValue = value.value.interpretedValue;
                        console.log(`Processing slot: ${key} = ${interpretedValue}`);
                        
                        if (key.toLowerCase() === 'email' && confirmationState === 'none' && !confirmedEmail) {
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(interpretedValue)) {
                                updateResponseArea("That doesn't seem like a valid email. Please say your email again.");
                                await speak("That doesn't seem like a valid email. Please say your email again.");
                                confirmationState = 'waitingForNewEmail';
                            } else {
                                lastProcessedEmail = interpretedValue;
                                document.getElementById('email').value = interpretedValue;
                                confirmationState = 'awaitingEmailConfirmation';
                                updateResponseArea(`I heard your email as: ${interpretedValue}. Is that correct? Say 'yes' or 'no'.`);
                                await speak(`I heard your email as: ${interpretedValue}. Is that correct? Say 'yes' or 'no'.`);
                                return;
                            }
                        } else if (confirmationState === 'none') {
                            document.getElementById(key.toLowerCase()).value = interpretedValue;
                        }
                    }
                }
                checkFormCompletion();
            }
    
            if (lexResponse.messages?.length > 0) {
                const message = lexResponse.messages[0].content;
                updateResponseArea(message);
                await speak(message);
            }
    
            if (lexResponse.sessionState?.intent?.state === 'Fulfilled') {
                updateResponseArea("All information collected. You can now submit the form.");
                await speak("All information collected. You can now submit the form.");
                stopListening();
                document.getElementById('submitButton').style.display = 'inline-flex';
            }
        }
    
        async function speak(text) {
            try {
                console.log("Sending to Polly:", text);
                const response = await fetch(`${API_ENDPOINT}/polly`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
    
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
                const data = await response.json();
                if (data.audio) await playAudio(data.audio);
                else throw new Error('No audio data received from Polly');
            } catch (error) {
                console.error("Error with text-to-speech:", error);
                updateResponseArea("Error with text-to-speech: " + error.message);
            }
        }
    
        async function playAudio(base64Audio) {
            return new Promise((resolve, reject) => {
                try {
                    const audio = new Audio("data:audio/mp3;base64," + base64Audio);
                    audio.onended = resolve;
                    audio.onerror = reject;
                    const playPromise = audio.play();
                    if (playPromise) playPromise.catch(reject);
                } catch (error) {
                    reject(error);
                }
            });
        }
    
        function updateResponseArea(text) {
            const responseArea = document.getElementById('responseArea');
            responseArea.textContent += text + '\n';
            responseArea.scrollTop = responseArea.scrollHeight;
        }
    </script>
</body>
</html>
